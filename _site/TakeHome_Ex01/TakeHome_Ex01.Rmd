---
title: "ISSS608 Take-Home Exercise 1"
description: |
  Using ggplot2 to prepare two sets of data visualisations.
author:
  - name: Melissa Tan 
    email: melissa.tan.2021@mitb.smu.edu.sg
    affiliation: SMU MITB Analytics Track
    affiliation_url: https://scis.smu.edu.sg/master-it-business/analytics-track/curriculum?gclid=CjwKCAiA3L6PBhBvEiwAINlJ9EJwYxpaZv-zPxR0UMntDh37TrlWU7jwXP9Dcu9jvWvN8uEJsOWzTRoCqrQQAvD_BwE
    
date: "`r Sys.Date()`"
output: distill::distill_article
---
# Data Preparation in R
For both visualisations, data extraction and wrangling were done in R using the *tidyverse* suite of packages. An addition *readxl* package was also installed to import the Superstore dataset as it was not part of the *tidyverse* suite. The *knitr* package was used to allow dataframe tables to be displayed. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
```{r echo=TRUE}
packages = c('tidyverse', 'readxl', 'knitr')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

# Visualisation 1: Pareto Chart of Returns by Sub-Category

First, the relevant data were important into the R environment. A new dataframe, *joined_tab* was created by using the *left_join()* function matched by each row's unique **Order ID**.


```{r echo=TRUE}
orders <- read_xls("data/Superstore-2021.xls",
                  sheet = "Orders")
returns <- read_xls("data/Superstore-2021.xls",
                  sheet = "Returns")
                  
joined_tab <- left_join(returns, orders,
                        by = c('Order ID' = 'Order ID'))
```

Next, the *group_by()* method was used to group the same Sub-Category items together, and *summarise()* was used to compute the count of **Returns** for each Sub-Category.

```{r echo=TRUE}
freq_returned <- joined_tab %>%
  group_by(`Sub-Category`) %>%
  summarise('Returns' = n()) %>%
  ungroup()
```

To calculate the **cumulative frequency**, the items were sorted in order of decreasing frequency by using *arrange(desc())*, and a new datafram column **cumfreq** was created to store the cumulative sum of **Returns**.

```{r}
freq_sorted <- freq_returned %>%
  arrange(desc(Returns))

freq_cum <- freq_sorted %>%
  mutate(cumfreq = cumsum(Returns))

kable(freq_cum)
```

## ggplot visualisation

A Pareto chart is a type of chart that contains both bars and a line graph, where individual values are represented in descending order by bars, and the cumulative total is represented by the line. 
While R has the *qcc* package to compute and plot such charts, for purposes of this take-home exercise, *ggplot2* was used to create the chart by appropriate layering and transformation.

### Plotting the bar chart
1. First, to plot the bar chart to show the absolute frequency of returns, *geom_bar()* was used. 
2. Next, to plot the cumulative frequency values in a line graph, *geom_line()* and *geom_point()* was applied.

+ The challenge for using *ggplot2* to prepare a Pareto chart is that the y-axes for the bar and line graphs are different if the **percentage** cumulative total is to be displayed. This is because to discourage manipulative and misleading data visualisation practices, R allows only scaling for the transformation of the secondary axis and the 2 axes cannot be separately defined. 

+ To overcome this, an appropriate scalar factor of *100/sum(freq_cum$Returns)* was determined for the secondary y-axis, where *sum(freq_cum$Returns)* refers to the total sum value of the Returns column which was then converted into a percentage figure by multiplying by 100.

3. Finally, formatting of the Pareto chart was done to improve ease of visualisation by using *theme()* e.g. using a minimalist theme, reducing the data ink of non-essential background and grid lines. 

4. The final Pareto Chart of Returns by Sub-Category is shown below:
```{r echo=TRUE}

ggplot(data=freq_cum, aes(x =reorder(`Sub-Category`, -`Returns`), y=`Returns`))+
  geom_bar(stat="identity", fill="lightblue")+
  geom_line(aes(y=`cumfreq`), colour = "black",size=0.5, group=1)+
  scale_y_continuous(sec.axis = sec_axis(~.*100/sum(freq_cum$Returns), name = "Percentage (%)"))+
  geom_point(aes(y=`cumfreq`), colour = "black", size=1)+
  xlab("Sub-Category") +
  ylab("Returns (Absolute Frequency)") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
        legend.position = "none",
        panel.background = element_rect(fill = "white",
                                        colour="white",
                                        size=0.5,
                                        linetype="solid"),
        panel.grid.major = element_line(size = 0.25,
                                        linetype = 'solid',
                                        colour = "lightgrey"),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5))+
  ggtitle ("Pareto Chart of Returns by Sub-Category")

```




```{r}
SGpop <- read_csv("data/respopagesextod2021.csv")

SGpop_gp <- SGpop %>%
  group_by(`Sex`,`AG`) %>%
  summarise('Pop'=sum(`Pop`)) %>%
  ungroup()

SGpop_gp$AG[SGpop_gp$AG=="5_to_9"] <- "05_to_9"

SGpop_gp$Sex[SGpop_gp$Sex=="Females"] <- "Female"
SGpop_gp$Sex[SGpop_gp$Sex=="Males"] <- "Male"

AG_new <- c("0-4", "5-9", "10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80-84","85-89","90 & over")

```

```{r}
ggplot(SGpop_gp, aes(x = `AG`, y = `Pop`, fill = `Sex`)) + 
  geom_bar(data = subset(SGpop_gp, Sex == "Female"), stat = "identity") + 
  geom_bar(data = subset(SGpop_gp, Sex == "Male"), aes(y=`Pop`*-1), stat = "identity") + 
  scale_y_continuous(name="Population ('000)", breaks = seq(-200000, 200000, 50000),
                     labels = paste0(as.character(c(seq(200, 0, -50), seq(50, 200, 50))))) + 
  scale_x_discrete(labels= AG_new)+
  xlab("Age (Years)")+
  coord_flip()+
  labs(title="Age-Sex Pyramid of Singapore Residents, June 2021")+
  guides(fill=guide_legend(title="Gender"))
```



